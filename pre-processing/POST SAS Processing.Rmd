---
title: "8.0 Appedix"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

###Library / Options
The following libraries and options were required for processes performed in this appendix. 
```{r message = FALSE}
#Libraries
if (!require(tidyverse)) {install.packages('tidyverse')} 
library(tidyverse)

if (!require(sp)) {install.packages('sp')} 
library(sp)

if (!require(tigris)) {install.packages('tigris')} 
library(tigris)

if (!require(knitr)) {install.packages('knitr')} 
library(knitr)

if (!require(kableExtra)) {install.packages('kableExtra')} 
library(kableExtra)

#Options
options(tigris_use_cache = TRUE)
```

#Section 8.1
##Processing EIA-923 and EIA-860 Data
###Inputs
The SAS data processing generated the files **EIA-923_Generation_and_Fuel_Data_Summary_2001_2018.csv** and **EIA_860M_COMPILED_LOCATION.csv**. File **energy_conversion_EIA-923.csv** lists every fuel type code from report EIA-923, along with energy type code and name defined by this project (see Section 2.2.) and whether or not the fuel would be considered Renewable or Non-Renewable. File **carbon_emission_factors.csv** contains the conversion factors for converting the type of energy source to average carbon dioxide (CO2) emission (see Section 2.2).
```{r}
#EIA-923
EIA_923 <- read.csv("./data/EIA-923_Generation_and_Fuel_Data_Summary_2001_2018.csv", stringsAsFactors = FALSE)

#EIA-860M
EIA_860M <- read.csv("./data/EIA_860M_COMPILED_LOCATION.csv", stringsAsFactors = FALSE)

#Project Definined Conversion Table for Defining Energy Types
EIA_923_energy_conv <- read.csv("./data/energy_conversion_EIA-923.csv", stringsAsFactors = FALSE)

#CO2 Emission Rates
EIA_923_emission <- read.csv("./data/carbon_emission_factors.csv", stringsAsFactors = FALSE)

#Color Palette
color_palette <- read.csv("./data/color_palette.csv", stringsAsFactors = FALSE)
```

###Cleaning and Consolidation

Plant Id and Entity Id were imported as integers, but function as unique identifiers for each plant and utility. Therefore, they are converted to characters for ease of use.
```{r}
## EIA-923
EIA_923$Plant.Id <- as.character(EIA_923$Plant.Id)

## EIA-860M
EIA_860M$Plant.Id <- as.character(EIA_860M$Plant.Id)
EIA_860M$Entity.Id <- as.character(EIA_860M$Entity.Id)
```

EIA_860M contained duplicate rows from the SAS processing step that must be removed. Rows with duplicate information were also removed. 

```{r}
EIA_860M <- EIA_860M %>% 
  select(-County, -State) %>% 
  distinct()
```

The column in EIA_860M for which state each plant was located had missing values. This information is essential for this application. Therefore,the state information for each plant was generated by matching longitude and latitude information to spatial shape files.

```{r}
EIA_860M_SP <- EIA_860M %>% 
  select(Longitude, Latitude)

df <- SpatialPoints(coords = EIA_860M_SP)

US <- states(cb = TRUE)

proj4string(df) <- proj4string(US)

df.over <- over(df, US)

EIA_860M_SP$State_SF <-df.over$STUSPS

EIA_860M$State_SF <- EIA_860M_SP$State_SF
```

The column for the net generation of megawatts in EIA-923 was renamed.
```{r}
EIA_923 <- EIA_923 %>% 
  rename(net_gen_mw = Net.Generation.Megawatthours.,
         Year = YEAR)
```

Dataframe EIA_923 is joined to EIA_860M and EIA_923_energy_conv, first by fuel code for EIA_923_energy_conv, then by Plant Id for EIA_860M. 
```{r}
EIA_923_860M_total <- EIA_923 %>% 
  left_join(y = EIA_923_energy_conv, by = c("ReportedFuel.Type.Code" = "EIA.923_reported_fuel.type_code")) %>% 
  left_join(y = EIA_860M, by = "Plant.Id") %>% 
  select(-ReportedFuel.Type.Code)
```

The following filtering processes were then performed on the joined dataset. 

* Rows with Plant ID 99999 were removed from the dataset. This plant ID was a code used for energy generated with no known plant to attribute it to. 
* Plants with net generation less than zero were removed.
* Plants with missing longitude and latitude information was filtered out of the dataset. 
```{r}
EIA_923_860M_1 <- EIA_923_860M_total %>% 
  filter(Plant.Id != "99999") %>% 
  filter(net_gen_mw > 0) %>% 
  drop_na()
```

###Processing

A new code was created for each observation that combined the Plant Id and the energy type. Each row would have a unique new code for each year the plant operated.
```{r}
#Create new observation code combining plant ID and energy type
EIA_923_860M_3 <- EIA_923_860M_1 %>% 
  mutate(Plant.ID_Energy = paste(Plant.Id, "_", project_energy_code)) %>% 
  select(Plant.Id, Plant.ID_Energy, Plant.Name, Entity.Id, Entity.Name, net_gen_mw,
         project_energy_code, project_energy_type, renewable, State_SF, Latitude, 
         Longitude, everything())
```

Currently the dataset lists each generator at each plant an observation. This analysis is only concerned with the total output of each energy type at each plant. Therefore, generators of the same energy type at the same plant are summed together. 

For example, a hydroelectric plant might consist of 5 turbines. These turbines are generators, and therefore for each year operation, the hydroelectric plant would have 5 separate observations. This process sums the net generated electricity for each turbine into a single observation.
```{r}
#Calculate sum of generation for each plant at each year for the same energy type
EIA_923_860M_summary <- EIA_923_860M_3 %>%
  group_by(Plant.ID_Energy, Year) %>% 
  summarise(net_gen_mw = sum(as.numeric(net_gen_mw)))

#Join summed generation with plant information
EIA_923_860M_4 <- EIA_923_860M_3 %>% 
  select(-net_gen_mw) %>% 
  distinct() %>% 
  left_join(EIA_923_860M_summary, by = c("Plant.ID_Energy", "Year"))
```

Each generator at a plant has a rated nameplate generation capacity. This is the amount of electricity generated over an hour from each generator when operating at 100% efficiency. Report EIA-860M provides the nameplate rating for each generator. A plant's nameplate generation rate is simply the sum of the generator's at each plant. For example, McGuire Nuclear Station, just outside of Charlotte, NC, has two generators, each with a nameplate rating of 1158MW, giving the plant an nameplate rating of 2136 MW. 

No plant operates, or is designed to operate, at 100% efficiency. But certain energy sources are expected to operate at much higher or lower rates than others. The percentage of power generated in comparison to nameplate rating is known as the capacity factor. Nuclear plants generally have capacity factor in the 90% range. Hydroelectric plants usually operate at less than 50%, and can range greatly. 

For this Shiny application, to better represent the actual output of each plant, an effective generation rate is calculated. The effective rate is average electricity generated per hour over the course of the applicable year. The effective generation rate will be used as opposed to the available nameplate rating.
```{r}
#Added Effective Generation Rate (MW)
EIA_923_860M_5 <- EIA_923_860M_4 %>% 
  mutate(Effective_Rate = round(net_gen_mw/(365*24), digits = 0))
```

The average CO2 emissions for each plant were calculated. See Section 2.2 for more information.
```{r}
#Add CO2 Emission Factor and CO2 Generated
emission_join <- EIA_923_emission %>% 
  select(-source)

#Calculate gCO2 Generated 
EIA_923_860M_6 <- EIA_923_860M_5 %>% 
  left_join(y = emission_join, by = "project_energy_code") %>% 
  mutate(emission_output = net_gen_mw*1000*emission_factor)
```

The variables were rearranged to a logical order, unnecessary variables were removed from the dataset. The following filtering steps were taken.

* Plants with an effective rate of less than 1 were removed from the dataset.
* Observations from the year 2018 were removed. The number of plants reported this year was approximately half of 2017, which generation remained steady. There appeared to be a change in reporting methodology. Therefore, to maintain a consistent dataset, observations from the year 2018 were removed.
```{r}
#Arrange
EIA_923_860M_7 <- EIA_923_860M_6 %>% 
  select(Plant.ID_Energy, Plant.Name,  project_energy_code, project_energy_type, renewable, net_gen_mw, emission_output, 
         Effective_Rate, State_SF, Latitude, Longitude, Year) %>% 
  arrange(Plant.ID_Energy, Year)

#Filter Out Effective Rates Less Than 1MW
EIA_923_860M_8 <- EIA_923_860M_7 %>% 
  filter(Effective_Rate >= 1)

#Filter Out 2018
EIA_923_860M_US <- EIA_923_860M_8 %>% 
  filter(Year != 2018)

```

This Shiny application is concerned only with the Southeast United States. Therefore, the dataset is filtered to the relevant states.
```{r Filter SE states from US}
#Filter to Southeast 
southeast_states <- c("VA", "KY", "NC", "SC", "GA", "FL","AL", "MS", "AR", "LA", "TN")

EIA_923_860M_SE <- EIA_923_860M_US %>% 
  filter(State_SF %in% southeast_states)
```

This dataset is the complete, tidy dataset of all relevant information used in the Shiny application.

```{r Writing Final Datasets, echo=FALSE}
#Write Dataset to CSV
write.csv(x = EIA_923_860M_US, file = "./data/EIA_923_860M_PROCESSED_US.csv")

write.csv(x = EIA_923_860M_SE, file = "./data/EIA_923_860M_PROCESSED_Southeast.csv")

```

#Section 8.2
##EIA-923 Energy Type Conversion Chart
```{r EIA-923 Conversion Table, echo = FALSE}
kable(EIA_923_energy_conv) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
                                      full_width = FALSE, position = "left", fixed_thead = TRUE)
```

