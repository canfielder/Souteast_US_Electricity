---
title: "Processing of SAS Output - EIA-923 and EIA-860M "
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Library / Options
The following libraries and options were required for data processing. 
```{r message = FALSE}
#Libraries
if (!require(tidyverse)) {install.packages('tidyverse')} 
library(tidyverse)

if (!require(sp)) {install.packages('sp')} 
library(sp)

if (!require(tigris)) {install.packages('tigris')} 
library(tigris)

if (!require(knitr)) {install.packages('knitr')} 
library(knitr)

#Options
options(tigris_use_cache = TRUE)
```

#Inputs
The SAS data processing generated the files **EIA-923_Generation_and_Fuel_Data_Summary_2001_2018.csv** and **EIA_860M_COMPILED_LOCATION.csv**. File **energy_conversion_EIA-923.csv** lists every fuel type code from report EIA-923, along with energy type code and name defined by this project (see Section 2.2.) and whether or not the fuel would be considered Renewable or Non-Renewable. File **carbon_emission_factors.csv** contains the conversion factors for converting the type of energy source to average carbon dioxide (CO2) emission (see Section 2.2).
```{r}
#EIA-923
EIA_923 <- read.csv("./data/EIA-923_Generation_and_Fuel_Data_Summary_2001_2018.csv", stringsAsFactors = FALSE)

#EIA-860M
EIA_860M <- read.csv("./data/EIA_860M_COMPILED_LOCATION.csv", stringsAsFactors = FALSE)

#Project Definined Conversion Table for Defining Energy Types
EIA_923_energy_conv <- read.csv("./data/energy_conversion_EIA-923.csv", stringsAsFactors = FALSE)

#CO2 Emission Rates
EIA_923_emission <- read.csv("./data/carbon_emission_factors.csv", stringsAsFactors = FALSE)

#Color Palette
color_palette <- read.csv("./data/color_palette.csv", stringsAsFactors = FALSE)
```

#Cleaning and Consolidation

Plant Id and Entity Id were imported as integers, but function as unique identifiers for each plant and utility. Therefore, they are converted to characters for ease of use.
```{r}
## EIA-923
EIA_923$Plant.Id <- as.character(EIA_923$Plant.Id)

## EIA-860M
EIA_860M$Plant.Id <- as.character(EIA_860M$Plant.Id)
EIA_860M$Entity.Id <- as.character(EIA_860M$Entity.Id)
```

EIA_860M contained duplicate rows from the SAS processing step that must be removed. Rows with duplicate information were also removed. 

```{r}
EIA_860M <- EIA_860M %>% 
  select(-County, -State) %>% 
  distinct()
```

The column in EIA_860M for which state each plant was located had missing values. This information is essential for this application. Therefore,the state information for each plant was generated by matching longitude and latitude information to spatial shape files.

```{r}
EIA_860M_SP <- EIA_860M %>% 
  select(Longitude, Latitude)

df <- SpatialPoints(coords = EIA_860M_SP)

US <- states(cb = TRUE)

proj4string(df) <- proj4string(US)

df.over <- over(df, US)

EIA_860M_SP$State_SF <-df.over$STUSPS

EIA_860M$State_SF <- EIA_860M_SP$State_SF
```

The column for the net generation of megawatts in EIA-923 was renamed.
```{r}
EIA_923 <- EIA_923 %>% 
  rename(net_gen_mw = Net.Generation.Megawatthours.,
         Year = YEAR)
```

Dataframe EIA_923 is joined to EIA_860M and EIA_923_energy_conv, first by fuel code for EIA_923_energy_conv, then by Plant Id for EIA_860M. 
```{r}
EIA_923_860M_total <- EIA_923 %>% 
  left_join(y = EIA_923_energy_conv, by = c("ReportedFuel.Type.Code" = "EIA.923_reported_fuel.type_code")) %>% 
  left_join(y = EIA_860M, by = "Plant.Id") %>% 
  select(-ReportedFuel.Type.Code)
```

The following filtering processes were then performed on the joined dataset. 

* Rows with Plant ID 99999 were removed from the dataset. This plant ID was a code used for energy generated with no known plant to attribute it to. 
* Plants with net generation less than zero were removed.
* Plants with missing longitude and latitude information was filtered out of the dataset. 
```{r}
EIA_923_860M_1 <- EIA_923_860M_total %>% 
  filter(Plant.Id != "99999") %>% 
  filter(net_gen_mw > 0) %>% 
  drop_na()
```

#Processing

A new code was created for each observation that combined the Plant Id and the energy type. Each row would have a unique new code for each year the plant operated.
```{r}
#Create new observation code combining plant ID and energy type
EIA_923_860M_3 <- EIA_923_860M_1 %>% 
  mutate(Plant.ID_Energy = paste(Plant.Id, "_", project_energy_code)) %>% 
  select(Plant.Id, Plant.ID_Energy, Plant.Name, Entity.Id, Entity.Name, net_gen_mw,
         project_energy_code, project_energy_type, renewable, State_SF, Latitude, 
         Longitude, everything())
```

Currently the dataset lists each generator at each plant an observation. This analysis is only concerned with the total output of each energy type at each plant. Therefore, generators of the same energy type at the same plant are summed together. 

For example, a hydroelectric plant might consist of 5 turbines. These turbines are generators, and therefore for each year operation, the hydroelectric plant would have 5 separate observations. This process sums the net generated electricity for each turbine into a single observation.
```{r}
#Calculate sum of generation for each plant at each year for the same energy type
EIA_923_860M_summary <- EIA_923_860M_3 %>%
  group_by(Plant.ID_Energy, Year) %>% 
  summarise(net_gen_mw = sum(as.numeric(net_gen_mw)))

#Join summed generation with plant information
EIA_923_860M_4 <- EIA_923_860M_3 %>% 
  select(-net_gen_mw) %>% 
  distinct() %>% 
  left_join(EIA_923_860M_summary, by = c("Plant.ID_Energy", "Year"))
```

Each generator at a plant has a rated nameplate generation capacity. This is the amount of electricity generated over an hour from each generator when operating at 100% efficiency. Report EIA-860M provides the nameplate rating for each generator. A plant's nameplate generation rate is simply the sum of the generator's at each plant. For example, McGuire Nuclear Station, just outside of Charlotte, NC, has two generators, each with a nameplate rating of 1158MW, giving the plant an nameplate rating of 2136 MW. 

No plant operates, or is designed to operate, at 100% efficiency. But certain energy sources are expected to operate at much higher or lower rates than others. The percentage of power generated in comparison to nameplate rating is known as the capacity factor. Nuclear plants generally have capacity factor in the 90% range. Hydroelectric plants usually operate at less than 50%, and can range greatly. 

For this Shiny application, to better represent the actual output of each plant, an effective generation rate is calculated. The effective rate is average electricity generated per hour over the course of the applicable year. The effective generation rate will be used as opposed to the available nameplate rating.
```{r}
#Added Effective Generation Rate (MW)
EIA_923_860M_5 <- EIA_923_860M_4 %>% 
  mutate(Effective_Rate = round(net_gen_mw/(365*24), digits = 0))
```

The average CO2 emissions for each plant were calculated. See Section 2.2 for more information.
```{r}
#Add CO2 Emission Factor and CO2 Generated
emission_join <- EIA_923_emission %>% 
  select(-source)

#Calculate gCO2 Generated 
EIA_923_860M_6 <- EIA_923_860M_5 %>% 
  left_join(y = emission_join, by = "project_energy_code") %>% 
  mutate(emission_output = net_gen_mw*1000*emission_factor)
```

The variables were rearranged to a logical order, unnecesary variables were removed from the dataset. Thethe following filtering steps were taken.

* Plants with an effective rate of less than 1 were removed from the dataset.
* Observations from the year 2018 were removed. The number of plants reported this year was approximately half of 2017, which generation remained steady. There appeared to be a change in reporting methodology. Therefore, to maintain a consistent dataset, observations from the year 2018 were removed.
```{r}
#Arrange
EIA_923_860M_7 <- EIA_923_860M_6 %>% 
  select(Plant.ID_Energy, Plant.Name,  project_energy_code, project_energy_type, renewable, net_gen_mw, emission_output, 
         Effective_Rate, State_SF, Latitude, Longitude, Year) %>% 
  arrange(Plant.ID_Energy, Year)

#Filter Out Effective Rates Less Than 1MW
EIA_923_860M_8 <- EIA_923_860M_7 %>% 
  filter(Effective_Rate >= 1)

#Filter Out 2018
EIA_923_860M_US <- EIA_923_860M_8 %>% 
  filter(Year != 2018)

```

This Shiny application is concerned only with the Southeast United States. Therefore, the dataset is filtered to the relevant states.
```{r}
#Filter to Southeast 
southeast_states <- c("VA", "KY", "NC", "SC", "GA", "FL","AL", "MS", "AR", "LA", "TN")

EIA_923_860M_SE <- EIA_923_860M_US %>% 
  filter(State_SF %in% southeast_states)
```

This dataset is the complete, tidy dataset of all revelvant information used in the Shiy application.

```{r echo=FALSE}
#Write Dataset to CSV
write.csv(x = EIA_923_860M_US, file = "./data/EIA_923_860M_PROCESSED_US.csv")

write.csv(x = EIA_923_860M_SE, file = "./data/EIA_923_860M_PROCESSED_Southeast.csv")

```

#Shiny App Function Specific Dataframes

```{r}
EIA_923_SE <- EIA_923_860M_SE
```

The following dataframes are specifically processed fro components of the shiny app to minimize process time durring the apps operation
```{r}
#For stacked bar and line graphs
net_generation_by_energy_type <- EIA_923_860M_SE %>% 
  
    #Convert project energy type to character
    mutate(project_energy_type = as.character(project_energy_type)) %>% 
    group_by(Year, State_SF, project_energy_type) %>% 
    summarise(total_gen = sum(net_gen_mw)) %>% 
    ungroup %>% 
  
    #join color palette data by project energy type
    full_join(y = color_palette, by = "project_energy_type") %>% 
    select(-c(project_energy_code:color_name)) %>% 
  
    #spread data so each project energy type is a seperate column
    spread(key = project_energy_type, value = total_gen) %>% 
    filter(!is.na(Year)) %>% 
    rename(Natural_Gas = 'Natural Gas') %>% 
    replace(is.na(.),0)
```

```{r}
#Write Dataset to CSV
write.csv(x = net_generation_by_energy_type, file = "./data/net_generation_by_energy_type.csv")
```

```{r}
EIA_923_SE_Filtered_Spread <- memoise(function(year, state) {
  
  df <- if (state == "SEUS"){
    net_generation_by_energy_type %>% 
      select(-X) %>% 
      filter(Year %in% (2001:year))
      
  } else {
   net_generation_by_energy_type %>%
      filter(Year %in% (2001:year), State_SF == state)
  }
  
df %>% 
  group_by(Year) %>% 
  summarise(Biomass = sum(Biomass),
            Coal = sum(Coal), 
            Hydroelectric = sum(Hydroelectric),
            Natural_Gas = sum(Natural_Gas), 
            Nuclear = sum(Nuclear),
            Oil  = sum(Oil),
            Other = sum(Other),
            Solar = sum(Solar),
            Wind = sum(Wind)
  )

})


df <- EIA_923_SE_Filtered_Spread(year = 2015, state = "NC") %>% 
  gather(key = energy_type, value = net_gen_mw, Biomass:Wind)

df

ggplot(data = df, mapping = aes(x = Year, y = net_gen_mw, color = energy_type)) +
  geom_point() +
  geom_line()
  
  

```

#Highcharter Data Processing
```{r}
net_gen_type_state <- EIA_923_SE %>% 
  #Convert project energy type to character
  mutate(project_energy_type = as.character(project_energy_type)) %>% 
  group_by(Year, State_SF, project_energy_type) %>% 
  summarise(total_gen = sum(net_gen_mw)) %>% 
  ungroup %>% 
  
  #join color palette data by project energy type
  full_join(y = color_palette, by = "project_energy_type") %>% 
  select(-c(project_energy_code:color_name)) %>% 
  
  #spread data so each project energy type is a seperate column
  spread(key = project_energy_type, value = total_gen) %>% 
  filter(!is.na(Year)) %>% 
  replace(is.na(.),0) %>% 
  #re-gather now that zeros have been substituted
  gather(key = project_energy_type, value = total_gen, Biomass:Wind)

net_gen_type_state

```

#Highchart Stackedbar data
```{r}

net_gen_type_state_hc$project_energy_type <- as.factor(net_gen_type_state_hc$project_energy_type)

levels(net_gen_type_state_hc$project_energy_type)


net_gen_type_state_hc$project_energy_type <- factor(net_gen_type_state_hc$project_energy_type, ordered = TRUE, 
                                       levels = c("Nuclear", "Coal", "Natural Gas", "Hydroelectric", 
                                                 "Biomass", "Oil", "Other", "Solar", "Wind"))
net_gen_type_seus_hc
```


#Emissions
```{r}
#Total Generation By State
net_get_total_state <- net_gen_type_state %>% 
  group_by(Year, State_SF) %>% 
  summarise(total_gen = sum(total_gen)) %>% 
  ungroup

emission_by_energy_type_state <- EIA_923_SE %>% 
  
  #Convert project energy type to character
  mutate(project_energy_type = as.character(project_energy_type)) %>% 
  group_by(Year, State_SF, project_energy_type) %>% 
  summarise(total_emis = sum(emission_output)) %>% 
  ungroup %>%
  
  #join color palette data by project energy type
  full_join(y = color_palette, by = "project_energy_type") %>% 
  select(-c(project_energy_code:color_name)) %>% 
  
  #spread data so each project energy type is a seperate column
  spread(key = project_energy_type, value = total_emis) %>%  
  filter(!is.na(Year)) %>%  
  replace(is.na(.),0) %>% 
  gather(key = project_energy_type, value = total_emis, Biomass:Wind)

#Emission By Type, All States
emission_by_energy_type_seus <- emission_by_energy_type_state %>% 
  group_by(Year, project_energy_type) %>% 
  summarise(total_emis = sum(total_emis),
            total_gen = sum(total_gen))

#Emission Total, By State
emission_total_state <- emission_by_energy_type_state %>% 
  group_by(Year, State_SF) %>% 
  summarise(total_emis = sum(total_emis)) %>% 
  left_join(y = net_get_total_state, by = c("Year", "State_SF")) %>% 
  mutate(emis_per_mw = total_emis / total_gen) %>% 
  replace(is.na(.),0)

#Emission Total, All States
emission_total_seus <- emission_total_state %>% 
  group_by(Year) %>% 
  summarise(total_emis = sum(total_emis),
            total_gen = sum(total_gen)) %>% 
  mutate(emis_per_mw = total_emis / total_gen) %>% 
  replace(is.na(.),0)


emission_by_energy_type_state %>% 
  filter(State_SF == "LA")

emission_by_energy_type_seus

emission_total_state

emission_total_seus

```

#Renewable
```{r}
 renewable_state<- EIA_923_SE %>% 
    group_by(Year, State_SF, renewable) %>% 
    summarise(total_gen = sum(net_gen_mw)) %>% 
    ungroup %>% 
    spread(key = renewable, value = total_gen) %>% 
    filter(!is.na(Year)) %>% 
    replace(is.na(.),0) %>% 
    gather(key = renewable, value = net_gen_mw, N:Y)

renewable_state

renewable_seus <- renewable_state %>% 
  group_by(Year, renewable) %>% 
    summarise(total_gen = sum(net_gen_mw)) %>% 
    ungroup 

renewable_seus

```

